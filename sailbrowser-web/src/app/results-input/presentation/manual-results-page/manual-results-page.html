<app-toolbar title="Results Entry">

  <button matButton (click)="publish()">  
    Publish results
  </button>
  <mat-form-field appearance="outline" class="race-selector dense-form-field" subscriptSizing="dynamic">
    <mat-select [formControl]="raceFilterControl" placeholder="Select Race">
      @for (race of currentRacesStore.selectedRaces(); track race.id) {
      <mat-option [value]="race.id">{{ race.seriesName }} - {{race.scheduledStart | date: "dd/mm/yy"}} Race {{
        race.raceOfDay }}</mat-option>
      }
    </mat-select>
  </mat-form-field>

  @if (selectedRace()) {
    <button matButton="outlined" (click)="setStartTime(selectedRace()!)">Set Start Time</button>
  }

</app-toolbar>

<div class="container">
  <div class="table-section">
    <app-manual-results-table [competitors]="sortedCompetitors()"
      (rowClicked)="onRowClick($event)"/>
  </div>

  <div class="input-section mat-elevation-z2">
    <h3>Record Result</h3>

    @if (selectedRace(); as race) {
      <div class="mode-display">
        <div class="mode-info">
          <mat-icon>{{ race.timeInputMode === 'elapsed' ? 'timer' : 'schedule' }}</mat-icon>
          <span>{{ race.timeInputMode === 'elapsed' ? 'Stopwatch' : 'Time of Day' }}</span>
        </div>
        @if(race.actualStart) {
          <span class="start-time">Start: {{ race.actualStart | date:'HH:mm:ss' }}</span>
        }
      </div>
    }

    @let stats = calculatedStats();
    <div class="stats-display" [class.suspicious]="stats?.isSuspicious">
      <div class="stat-row">
        <span>Elapsed: <b>{{ stats ? (stats.elapsedSeconds | duration) : ''}}</b></span>
        <span>Avg Lap: <b>{{ stats ? (stats.avgLapTime | duration) : ''}}</b></span>
      </div>
    </div>

    <form [formGroup]="form" (ngSubmit)="save()">

      <mat-form-field appearance="outline">
        <mat-label>Competitor</mat-label>
        <input matInput [formControl]="searchControl" [matAutocomplete]="auto" placeholder="Class or Sail No">
        <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn"
          (optionSelected)="onCompetitorSelected($event)">
          @for (comp of autoCompleteCompetitors(); track comp.id) {
          <mat-option [value]="comp">
            {{comp.boatClass}} {{comp.sailNumber}} - {{comp.helm}}
          </mat-option>
          }
        </mat-autocomplete>
        @if(searchControl.value) {
          <button mat-icon-button matSuffix (click)="searchControl.setValue('')" aria-label="Clear search">
            <mat-icon>close</mat-icon>
          </button>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Finish Time</mat-label>
        <app-race-time-input formControlName="finishTime" [mode]="timeInputContext().mode"
          [baseTime]="timeInputContext().baseTime">
        </app-race-time-input>
        @if (form.controls.finishTime.hasError('timeGreaterThan')) {
          <mat-error>Finish time must be after start time</mat-error>
        }
        @if (form.controls.finishTime.hasError('positiveDuration')) {
          <mat-error>Elapsed time must be positive</mat-error>
        }
        @if (form.controls.finishTime.hasError('required')) {
          <mat-error>Finish time is required</mat-error>
        }
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Laps</mat-label>
        <input matInput type="number" formControlName="laps">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Result Code</mat-label>
        <mat-select formControlName="resultCode">
          @for (code of resultCodes; track code.id) {
            <mat-option [value]="code.id">{{ code.id }}</mat-option>
          }
        </mat-select>
        <mat-hint>{{ resultCodeDescription() }}</mat-hint>
      </mat-form-field>

      <div class="actions">
        <button mat-button type="button" (click)="resetForm()">Clear</button>
        <button mat-flat-button color="primary" type="submit" [disabled]="form.invalid">Record</button>
      </div>
    </form>
  </div>
</div>
