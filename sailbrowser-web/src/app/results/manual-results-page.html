<app-toolbar title="Results Entry">
  <mat-form-field appearance="outline" class="race-selector dense-form-field" subscriptSizing="dynamic" >
    <mat-select [formControl]="raceFilterControl" multiple placeholder="Select Races">
      @for (race of currentRacesStore.selectedRaces(); track race.id) {
        <mat-option [value]="race.id">{{ race.seriesName }} - {{race.scheduledStart | date: "dd/mm/yy"}} Race {{ race.raceOfDay }}</mat-option>
      }
    </mat-select>
  </mat-form-field>
  <mat-button-toggle-group [formControl]="timeTypeControl" class="toolbar-toggle">
    <mat-button-toggle value="tod">Time of Day</mat-button-toggle>
    <mat-button-toggle value="elapsed">Elapsed</mat-button-toggle>
  </mat-button-toggle-group>
</app-toolbar>

<div class="container">
  <div class="table-section">
    <table mat-table [dataSource]="sortedCompetitors()" class="mat-elevation-z0">
      
      <ng-container matColumnDef="boatClass">
        <th mat-header-cell *matHeaderCellDef> Class </th>
        <td mat-cell *matCellDef="let element"> {{element.boatClass}} </td>
      </ng-container>

      <ng-container matColumnDef="sailNumber">
        <th mat-header-cell *matHeaderCellDef> Sail No </th>
        <td mat-cell *matCellDef="let element"> {{element.sailNumber}} </td>
      </ng-container>

          <ng-container matColumnDef="helm">
            <th mat-header-cell *matHeaderCellDef> Helm </th>
            <td mat-cell *matCellDef="let element"> {{element.helm}} </td>
          </ng-container>

      <ng-container matColumnDef="finishTime">
        <th mat-header-cell *matHeaderCellDef> Finish Time </th>
        <td mat-cell *matCellDef="let element"> {{element.manualFinishTime | date:'HH:mm:ss'}} </td>
      </ng-container>

      <ng-container matColumnDef="laps">
        <th mat-header-cell *matHeaderCellDef> Laps </th>
        <td mat-cell *matCellDef="let element"> {{element.manualLaps}} </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
          [class.processed]="!!row.manualFinishTime"
          (click)="onRowClick(row)">
      </tr>
    </table>
  </div>

  <div class="input-section mat-elevation-z2">
    <h3>Record Result</h3>
    <form [formGroup]="form" (ngSubmit)="save()">
      
      <mat-form-field appearance="outline">
        <mat-label>Search Competitor</mat-label>
        <input matInput [formControl]="searchControl" [matAutocomplete]="auto" placeholder="Class or Sail No">
        <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onCompetitorSelected($event)">
          @for (comp of filteredCompetitors(); track comp.id) {
            <mat-option [value]="comp">
              {{comp.boatClass}} {{comp.sailNumber}} - {{comp.helm}}
            </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Time ({{ timeTypeControl.value === 'tod' ? 'HH:mm:ss' : 'mm:ss' }})</mat-label>
        <input matInput type="time" step="1" formControlName="time">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Laps</mat-label>
        <input matInput type="number" formControlName="laps">
      </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Result Code</mat-label>
          <mat-select formControlName="resultCode">
            @for (code of resultCodes; track code.code) {
            <mat-option [value]="code.code">{{ code.displayName }}</mat-option>
            }
          </mat-select>
          <mat-hint>{{ resultCodeDescription() }}</mat-hint>
        </mat-form-field>

      <div class="actions">
        <button mat-button type="button" (click)="resetForm()">Clear</button>
        <button mat-flat-button color="primary" type="submit" [disabled]="form.invalid">Record</button>
      </div>
    </form>
  </div>
</div>